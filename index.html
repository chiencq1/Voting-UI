<!DOCTYPE html>
<html>
<head>
    <title>Blockchain Voting Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.min.js"></script>
</head>
<body>
<h2>Limited Multiple Voting (Max 3 votes)</h2>

<button onclick="connectWallet()">Connect MetaMask</button>
<p id="wallet"></p>

<select id="candidate">
  <option value="0">Candidate A</option>
  <option value="1">Candidate B</option>
  <option value="2">Candidate C</option>
</select>

<button onclick="vote()">Vote</button>

<h3>Remaining Votes: <span id="remaining"></span></h3>

<h3>Live Results</h3>
<p>A: <span id="a"></span></p>
<p>B: <span id="b"></span></p>
<p>C: <span id="c"></span></p>

<script>
const contractAddress = "0xf95EFe04186C95F9B3a6cfD49ac4f56c2d99b48C";
const abi = [
  {
    "inputs": [],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "anonymous": false,
    "inputs": [
      {
        "indexed": false,
        "internalType": "address",
        "name": "voter",
        "type": "address"
      },
      {
        "indexed": false,
        "internalType": "uint8",
        "name": "candidate",
        "type": "uint8"
      },
      {
        "indexed": false,
        "internalType": "uint8",
        "name": "voteCount",
        "type": "uint8"
      }
    ],
    "name": "Voted",
    "type": "event"
  },
  {
    "inputs": [],
    "name": "MAX_VOTES",
    "outputs": [
      {
        "internalType": "uint8",
        "name": "",
        "type": "uint8"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "candidateCount",
    "outputs": [
      {
        "internalType": "uint8",
        "name": "",
        "type": "uint8"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint8",
        "name": "",
        "type": "uint8"
      }
    ],
    "name": "candidateVotes",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "_voter",
        "type": "address"
      }
    ],
    "name": "getRemainingVotes",
    "outputs": [
      {
        "internalType": "uint8",
        "name": "",
        "type": "uint8"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint8",
        "name": "_candidate",
        "type": "uint8"
      }
    ],
    "name": "getVotes",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "owner",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint8",
        "name": "_candidate",
        "type": "uint8"
      }
    ],
    "name": "resetVotes",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint8",
        "name": "_candidate",
        "type": "uint8"
      }
    ],
    "name": "vote",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "name": "voters",
    "outputs": [
      {
        "internalType": "uint8",
        "name": "voteCount",
        "type": "uint8"
      },
      {
        "internalType": "uint8",
        "name": "lastVote",
        "type": "uint8"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];

let provider, signer, contract, userAddress;

    async function connect() {
        // Kiểm tra MetaMask ở đây là đủ
        if (!window.ethereum) {
            alert("Please install MetaMask!");
            return;
        }

        try {
            const provider = new ethers.BrowserProvider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            const signer = await provider.getSigner();
            
            contract = new ethers.Contract(address, abi, signer);
            
            // Đổi nút bấm thành địa chỉ ví
            const userAddress = await signer.getAddress();
            document.getElementById("connect").innerText = "Connected: " + userAddress.slice(0, 6) + "...";

            await loadMessage();

            // Lắng nghe sự kiện
            contract.on("MessageUpdated", (sender, newMessage) => {
                console.log("Event received:", sender, newMessage);
                document.getElementById("log").innerHTML += `<p style="color: green;">User ${sender.slice(0,6)}... updated: ${newMessage}</p>`;
                document.getElementById("msg").innerText = newMessage;
            });

        } catch (error) {
            console.error("Lỗi kết nối:", error);
            alert("Có lỗi khi kết nối ví. Xem Console (F12) để biết chi tiết.");
        }
    }

async function vote() {
    const c = document.getElementById("candidate").value;

    const tx = await contract.vote(c);
    await tx.wait(); // chờ confirm

    alert("Vote success!");
}

async function updateResults() {
    document.getElementById("a").innerText = (await contract.getVotes(0)).toString();
    document.getElementById("b").innerText = (await contract.getVotes(1)).toString();
    document.getElementById("c").innerText = (await contract.getVotes(2)).toString();
}

async function updateRemaining() {
    const r = await contract.getRemainingVotes(userAddress);
    document.getElementById("remaining").innerText = r;
}

function listenEvents() {
    contract.on("Voted", (voter, candidate, count) => {
        console.log("New vote:", voter, candidate, count);
        updateResults();
        updateRemaining();
    });
}
</script>
</body>
</html>